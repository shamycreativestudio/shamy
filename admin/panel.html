<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Administraci√≥n - Shamy Branding</title>
    <link rel="icon" type="image/svg+xml" href="../assets/img/favicon.svg" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #000000;
        --bg: #fafafa;
        --panel: #ffffff;
        --border: #e0e0e0;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #3b82f6;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          sans-serif;
        background: var(--bg);
        line-height: 1.6;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
      }

      header {
        background: var(--primary);
        color: white;
        padding: 1.5rem 0;
        margin-bottom: 2rem;
      }

      header .container {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      h1 {
        font-size: 1.75rem;
        font-weight: 700;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: var(--panel);
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid var(--border);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .stat-card h3 {
        font-size: 0.875rem;
        color: #666;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-card .value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary);
      }

      .filters {
        background: var(--panel);
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid var(--border);
        margin-bottom: 2rem;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
      }

      .filters label {
        font-weight: 600;
        font-size: 0.875rem;
      }

      .filters select,
      .filters input {
        padding: 0.5rem;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 0.875rem;
      }

      .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.2s;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        opacity: 0.9;
      }

      table {
        width: 100%;
        background: var(--panel);
        border-collapse: collapse;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      thead {
        background: #f8f9fa;
      }

      th {
        text-align: left;
        padding: 1rem;
        font-weight: 700;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #666;
        border-bottom: 2px solid var(--border);
      }

      td {
        padding: 1rem;
        border-bottom: 1px solid var(--border);
      }

      tbody tr:hover {
        background: #f8f9fa;
      }

      .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .badge-nuevo {
        background: #dbeafe;
        color: #1e40af;
      }

      .badge-en_revision {
        background: #fef3c7;
        color: #92400e;
      }

      .badge-aprobado {
        background: #d1fae5;
        color: #065f46;
      }

      .badge-rechazado {
        background: #fee2e2;
        color: #991b1b;
      }

      .actions {
        display: flex;
        gap: 0.5rem;
      }

      .btn-sm {
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
      }

      .btn-view {
        background: var(--info);
        color: white;
      }

      .btn-edit {
        background: var(--warning);
        color: white;
      }

      .btn-delete {
        background: var(--danger);
        color: white;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        padding: 2rem;
        overflow-y: auto;
      }

      .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: var(--panel);
        border-radius: 8px;
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        padding: 2rem;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border);
      }

      .modal-header h2 {
        font-size: 1.5rem;
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        color: #666;
      }

      .detail-section {
        margin-bottom: 1.5rem;
      }

      .detail-section h3 {
        font-size: 1rem;
        margin-bottom: 0.75rem;
        color: var(--primary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .detail-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      }

      .detail-item {
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 4px;
      }

      .detail-item label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: #666;
        margin-bottom: 0.25rem;
        text-transform: uppercase;
      }

      .detail-item .value {
        font-size: 0.875rem;
        color: var(--primary);
      }

      .loading {
        text-align: center;
        padding: 3rem;
        color: #666;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #666;
      }

      .empty-state svg {
        width: 64px;
        height: 64px;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
      }

      .pagination button {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border);
        background: var(--panel);
        border-radius: 4px;
        cursor: pointer;
      }

      .pagination button.active {
        background: var(--primary);
        color: white;
      }

      .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <h1>üé® Panel de Administraci√≥n - Shamy Branding</h1>
        <button class="btn btn-primary" onclick="loadBriefs()">
          üîÑ Actualizar
        </button>
      </div>
    </header>

    <div class="container">
      <!-- Estad√≠sticas -->
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <h3>Total Briefs</h3>
          <div class="value" id="statTotal">0</div>
        </div>
        <div class="stat-card">
          <h3>Nuevos</h3>
          <div class="value" id="statNuevos">0</div>
        </div>
        <div class="stat-card">
          <h3>En Revisi√≥n</h3>
          <div class="value" id="statRevision">0</div>
        </div>
        <div class="stat-card">
          <h3>Aprobados</h3>
          <div class="value" id="statAprobados">0</div>
        </div>
      </div>

      <!-- Filtros -->
      <div class="filters">
        <label
          >Estado:
          <select id="filterEstado" onchange="loadBriefs()">
            <option value="">Todos</option>
            <option value="nuevo">Nuevo</option>
            <option value="en_revision">En Revisi√≥n</option>
            <option value="aprobado">Aprobado</option>
            <option value="rechazado">Rechazado</option>
          </select>
        </label>
        <label
          >Buscar:
          <input type="text" id="searchInput" placeholder="Nombre o email..." />
        </label>
        <button class="btn btn-primary" onclick="loadBriefs()">Buscar</button>
      </div>

      <!-- Tabla de briefs -->
      <div id="briefsTable"></div>

      <!-- Paginaci√≥n -->
      <div class="pagination" id="pagination"></div>
    </div>

    <!-- Modal de detalles -->
    <div class="modal" id="detailModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Detalles del Brief</h2>
          <button class="close-modal" onclick="closeModal()">&times;</button>
        </div>
        <div id="modalBody"></div>
      </div>
    </div>

    <script>
      // Configuraci√≥n
      const API_BASE = "/api";
      const AUTH_CREDENTIALS = btoa("admin:shamy2025"); // Sincronizado con .env
      let currentPage = 1;

      // Cargar estad√≠sticas
      async function loadStats() {
        try {
          const response = await fetch(`${API_BASE}/admin/stats`);
          const data = await response.json();

          document.getElementById("statTotal").textContent = data.total_briefs;

          const estados = data.briefs_por_estado.reduce((acc, item) => {
            acc[item.estado] = item.count;
            return acc;
          }, {});

          document.getElementById("statNuevos").textContent =
            estados.nuevo || 0;
          document.getElementById("statRevision").textContent =
            estados.en_revision || 0;
          document.getElementById("statAprobados").textContent =
            estados.aprobado || 0;
        } catch (error) {
          console.error("Error cargando estad√≠sticas:", error);
        }
      }

      // Cargar briefs
      async function loadBriefs(page = 1) {
        const estado = document.getElementById("filterEstado").value;
        const search = document.getElementById("searchInput").value;

        const tableContainer = document.getElementById("briefsTable");
        tableContainer.innerHTML =
          '<div class="loading"><div class="spinner"></div><p>Cargando briefs...</p></div>';

        try {
          const params = new URLSearchParams({
            page: page,
            limit: 20,
          });

          if (estado) params.append("estado", estado);

          const response = await fetch(`${API_BASE}/briefs?${params}`, {
            headers: {
              Authorization: `Basic ${AUTH_CREDENTIALS}`,
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error("Error response:", errorText);
            throw new Error(`Error al cargar briefs: ${response.status}`);
          }

          const data = await response.json();
          currentPage = page;

          renderTable(data.briefs);
          renderPagination(data.pagination);
        } catch (error) {
          console.error("Error completo:", error);
          tableContainer.innerHTML = `
          <div class="empty-state">
            <p>Error al cargar los briefs</p>
            <small style="color: #999;">Revisa la consola (F12) para m√°s detalles</small>
            <br><br>
            <button class="btn btn-primary" onclick="loadBriefs()">Reintentar</button>
          </div>
        `;
        }
      }

      // Renderizar tabla
      function renderTable(briefs) {
        const container = document.getElementById("briefsTable");

        if (briefs.length === 0) {
          container.innerHTML =
            '<div class="empty-state"><p>No hay briefs para mostrar</p></div>';
          return;
        }

        const table = `
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Empresa</th>
              <th>Contacto</th>
              <th>Email</th>
              <th>Tel√©fono</th>
              <th>Estado</th>
              <th>Fecha</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${briefs
              .map(
                (brief) => `
              <tr>
                <td>#${brief.id}</td>
                <td><strong>${brief.empresa_nombre}</strong></td>
                <td>${brief.contacto_nombre_cargo}</td>
                <td>${brief.contacto_email}</td>
                <td>${brief.contacto_telefono}</td>
                <td><span class="badge badge-${
                  brief.estado
                }">${brief.estado.replace("_", " ")}</span></td>
                <td>${new Date(brief.created_at).toLocaleDateString(
                  "es-ES"
                )}</td>
                <td class="actions">
                  <button class="btn btn-sm btn-view" onclick="viewBrief(${
                    brief.id
                  })">Ver</button>
                  <button class="btn btn-sm btn-edit" onclick="changeStatus(${
                    brief.id
                  })">Estado</button>
                  <button class="btn btn-sm btn-delete" onclick="deleteBrief(${
                    brief.id
                  })">Eliminar</button>
                </td>
              </tr>
            `
              )
              .join("")}
          </tbody>
        </table>
      `;

        container.innerHTML = table;
      }

      // Renderizar paginaci√≥n
      function renderPagination(pagination) {
        const container = document.getElementById("pagination");

        const buttons = [];

        // Bot√≥n anterior
        buttons.push(`
        <button ${pagination.page === 1 ? "disabled" : ""} 
                onclick="loadBriefs(${pagination.page - 1})">
          ‚Üê Anterior
        </button>
      `);

        // P√°ginas
        for (let i = 1; i <= pagination.totalPages; i++) {
          if (
            i === 1 ||
            i === pagination.totalPages ||
            (i >= pagination.page - 2 && i <= pagination.page + 2)
          ) {
            buttons.push(`
            <button class="${i === pagination.page ? "active" : ""}" 
                    onclick="loadBriefs(${i})">
              ${i}
            </button>
          `);
          } else if (i === pagination.page - 3 || i === pagination.page + 3) {
            buttons.push("<span>...</span>");
          }
        }

        // Bot√≥n siguiente
        buttons.push(`
        <button ${pagination.page === pagination.totalPages ? "disabled" : ""} 
                onclick="loadBriefs(${pagination.page + 1})">
          Siguiente ‚Üí
        </button>
      `);

        container.innerHTML = buttons.join("");
      }

      // Ver detalles de brief
      async function viewBrief(id) {
        const modal = document.getElementById("detailModal");
        const body = document.getElementById("modalBody");

        body.innerHTML =
          '<div class="loading"><div class="spinner"></div></div>';
        modal.classList.add("active");

        try {
          const response = await fetch(`${API_BASE}/briefs/${id}`, {
            headers: {
              Authorization: `Basic ${AUTH_CREDENTIALS}`,
            },
          });

          const data = await response.json();
          renderBriefDetails(data);
        } catch (error) {
          console.error("Error:", error);
          body.innerHTML = "<p>Error al cargar los detalles</p>";
        }
      }

      // Renderizar detalles completos
      function renderBriefDetails(data) {
        const brief = data.brief;
        const body = document.getElementById("modalBody");

        body.innerHTML = `
        <div class="detail-section">
          <h3>Datos B√°sicos</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>Empresa</label>
              <div class="value">${brief.empresa_nombre}</div>
            </div>
            <div class="detail-item">
              <label>Contacto</label>
              <div class="value">${brief.contacto_nombre_cargo}</div>
            </div>
            <div class="detail-item">
              <label>Email</label>
              <div class="value">${brief.contacto_email}</div>
            </div>
            <div class="detail-item">
              <label>Tel√©fono</label>
              <div class="value">${brief.contacto_telefono}</div>
            </div>
            <div class="detail-item">
              <label>Ciudad</label>
              <div class="value">${brief.ciudad || "No especificado"}</div>
            </div>
            <div class="detail-item">
              <label>Estado</label>
              <div class="value"><span class="badge badge-${brief.estado}">${
          brief.estado
        }</span></div>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>Descripci√≥n</h3>
          <div class="detail-item">
            <div class="value">${
              brief.descripcion_breve || "No especificado"
            }</div>
          </div>
        </div>

        <div class="detail-section">
          <h3>Necesidades</h3>
          <div class="detail-item">
            <div class="value">${brief.necesidades_principales.join(", ")}</div>
          </div>
        </div>

        ${
          brief.objetivos_secundarios.length > 0
            ? `
          <div class="detail-section">
            <h3>Objetivos Secundarios</h3>
            <div class="detail-item">
              <div class="value">${brief.objetivos_secundarios.join(", ")}</div>
            </div>
          </div>
        `
            : ""
        }

        ${
          data.files.length > 0
            ? `
          <div class="detail-section">
            <h3>Archivos Adjuntos (${data.files.length})</h3>
            <ul>
              ${data.files
                .map(
                  (f) => `
                <li><a href="/uploads/${f.stored_name}" target="_blank">${
                    f.original_name
                  }</a> (${(f.file_size / 1024).toFixed(2)} KB)</li>
              `
                )
                .join("")}
            </ul>
          </div>
        `
            : ""
        }

        <div class="detail-section">
          <h3>Datos Completos (JSON)</h3>
          <details>
            <summary>Ver JSON completo</summary>
            <pre style="background: #f8f9fa; padding: 1rem; border-radius: 4px; overflow-x: auto; font-size: 0.75rem;">${JSON.stringify(
              brief,
              null,
              2
            )}</pre>
          </details>
        </div>
      `;
      }

      // Cambiar estado
      async function changeStatus(id) {
        const newStatus = prompt(
          "Nuevo estado:\n- nuevo\n- en_revision\n- aprobado\n- rechazado"
        );

        if (!newStatus) return;

        const validStates = ["nuevo", "en_revision", "aprobado", "rechazado"];
        if (!validStates.includes(newStatus)) {
          alert("Estado inv√°lido");
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/briefs/${id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Basic ${AUTH_CREDENTIALS}`,
            },
            body: JSON.stringify({ estado: newStatus }),
          });

          if (response.ok) {
            alert("Estado actualizado");
            loadBriefs(currentPage);
            loadStats();
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error al actualizar el estado");
        }
      }

      // Eliminar brief
      async function deleteBrief(id) {
        if (!confirm("¬øEst√°s seguro de que quieres eliminar este brief?"))
          return;

        try {
          const response = await fetch(`${API_BASE}/briefs/${id}`, {
            method: "DELETE",
            headers: {
              Authorization: `Basic ${AUTH_CREDENTIALS}`,
            },
          });

          if (response.ok) {
            alert("Brief eliminado");
            loadBriefs(currentPage);
            loadStats();
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error al eliminar el brief");
        }
      }

      // Cerrar modal
      function closeModal() {
        document.getElementById("detailModal").classList.remove("active");
      }

      // Cargar al iniciar
      loadStats();
      loadBriefs();

      // Actualizar cada 30 segundos
      setInterval(() => {
        loadStats();
      }, 30000);
    </script>
  </body>
</html>
